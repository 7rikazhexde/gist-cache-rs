name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Test mode (creates draft release)'
        required: false
        default: 'true'

permissions:
  contents: write

jobs:
  build-release:
    name: Build Release
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: gist-cache-rs
            asset_name: gist-cache-rs-linux-x86_64.tar.gz
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact_name: gist-cache-rs
            asset_name: gist-cache-rs-macos-x86_64.tar.gz
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact_name: gist-cache-rs
            asset_name: gist-cache-rs-macos-aarch64.tar.gz
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: gist-cache-rs.exe
            asset_name: gist-cache-rs-windows-x86_64.tar.gz

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Build release binary
        run: cargo build --release --target ${{ matrix.target }}

      - name: Strip binary (Linux and macOS)
        if: matrix.os != 'windows-latest'
        run: strip target/${{ matrix.target }}/release/${{ matrix.artifact_name }}

      - name: Create archive
        shell: bash
        run: |
          # Extract version from tag (remove 'v' prefix)
          VERSION="${GITHUB_REF_NAME#v}"
          # Get OS and arch from target triple
          case "${{ matrix.target }}" in
            x86_64-unknown-linux-gnu)
              ASSET_NAME="gist-cache-rs-${VERSION}-x86_64-unknown-linux-gnu.tar.gz"
              ;;
            x86_64-apple-darwin)
              ASSET_NAME="gist-cache-rs-${VERSION}-x86_64-apple-darwin.tar.gz"
              ;;
            aarch64-apple-darwin)
              ASSET_NAME="gist-cache-rs-${VERSION}-aarch64-apple-darwin.tar.gz"
              ;;
            x86_64-pc-windows-msvc)
              ASSET_NAME="gist-cache-rs-${VERSION}-x86_64-pc-windows-msvc.tar.gz"
              ;;
          esac

          # Change to target directory
          cd target/${{ matrix.target }}/release

          # Create staging directory with version and target in name
          STAGING_DIR="gist-cache-rs-${VERSION}-${{ matrix.target }}"
          mkdir -p "$STAGING_DIR"

          # Copy binary to staging directory
          cp ${{ matrix.artifact_name }} "$STAGING_DIR/"

          # Create archive from staging directory
          tar czf "$ASSET_NAME" "$STAGING_DIR"

          # Move archive to workspace root
          mv "$ASSET_NAME" "$GITHUB_WORKSPACE"/
          echo "ASSET_NAME=$ASSET_NAME" >> $GITHUB_ENV

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ASSET_NAME }}
          path: ${{ env.ASSET_NAME }}

  create-release:
    name: Create Release
    needs: build-release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v6
        with:
          path: artifacts

      - name: Move artifacts to root
        run: |
          find artifacts -type f -exec mv {} . \;

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event_name == 'workflow_dispatch' && 'test-release' || github.ref_name }}
          name: ${{ github.event_name == 'workflow_dispatch' && '[TEST] Workflow Test Release' || format('Release {0}', github.ref_name) }}
          draft: ${{ github.event_name == 'workflow_dispatch' }}
          prerelease: false
          generate_release_notes: false
          body: |
            ${{ github.event_name == 'workflow_dispatch' && '⚠️ **This is a test release created by manual workflow dispatch. Safe to delete.**' || '' }}

            ## Changes in ${{ github.ref }}

            See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details.

            ## Installation

            Download the appropriate binary for your platform below.

            ### Linux
            ```bash
            VERSION=${{ github.ref_name }}
            curl -L https://github.com/${{ github.repository }}/releases/download/${VERSION}/gist-cache-rs-${VERSION#v}-x86_64-unknown-linux-gnu.tar.gz | tar xz
            sudo mv gist-cache-rs /usr/local/bin/
            ```

            ### macOS (Intel)
            ```bash
            VERSION=${{ github.ref_name }}
            curl -L https://github.com/${{ github.repository }}/releases/download/${VERSION}/gist-cache-rs-${VERSION#v}-x86_64-apple-darwin.tar.gz | tar xz
            sudo mv gist-cache-rs /usr/local/bin/
            ```

            ### macOS (Apple Silicon)
            ```bash
            VERSION=${{ github.ref_name }}
            curl -L https://github.com/${{ github.repository }}/releases/download/${VERSION}/gist-cache-rs-${VERSION#v}-aarch64-apple-darwin.tar.gz | tar xz
            sudo mv gist-cache-rs /usr/local/bin/
            ```

            ### Windows
            ```powershell
            # Download and extract (requires tar which is available in Windows 10+)
            $VERSION = "${{ github.ref_name }}"
            $VERSION_NUM = $VERSION.TrimStart("v")
            curl -L https://github.com/${{ github.repository }}/releases/download/$VERSION/gist-cache-rs-$VERSION_NUM-x86_64-pc-windows-msvc.tar.gz -o gist-cache-rs.tar.gz
            tar xzf gist-cache-rs.tar.gz
            # Move to a directory in your PATH (e.g., C:\Users\<YourName>\.cargo\bin\)
            move gist-cache-rs.exe $env:USERPROFILE\.cargo\bin\
            ```

            ## Self-Update

            After installation, you can update using:
            ```bash
            gist-cache-rs self update
            ```
          files: |
            gist-cache-rs-*-*.tar.gz
